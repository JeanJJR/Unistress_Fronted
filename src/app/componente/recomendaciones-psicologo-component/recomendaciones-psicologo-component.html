<div class="main-content">
  <h2 class="page-title">Recomendaciones</h2>

  <div class="form-container">
    <form [formGroup]="recomendacionForm" class="form-container" (ngSubmit)="onSubmit()">
      <div class="form-row">

        <!-- Selección de estudiante -->
        <mat-form-field appearance="fill" class="form-field-half">
          <mat-label>Estudiante</mat-label>
          <mat-select formControlName="estudianteId">
            <mat-option *ngFor="let estudiante of estudiantes" [value]="estudiante.id">
              {{estudiante.nombre}} {{estudiante.apellidos}}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="recomendacionForm.get('estudianteId')?.hasError('required')">
            Seleccione un estudiante
          </mat-error>
        </mat-form-field>

        <!-- Selección de registro emocional -->
        <mat-form-field appearance="fill" class="form-field-half">
          <mat-label>Registro emocional</mat-label>
          <mat-select formControlName="registroEmocionalId">
            <mat-option *ngIf="registrosEmocionales.length === 0" [disabled]="true">
              (Seleccione un estudiante primero)
            </mat-option>
            <mat-option *ngFor="let registro of registrosEmocionales"
                        [value]="registro.id"
                        [matTooltip]="registro.descripcion"
                        matTooltipClass="tooltip-scroll"
                        matTooltipPosition="right">
              <strong>{{ registro.fechaRegistro | date: 'dd/MM/yyyy' }}</strong>
              - {{ registro.emocion }}
            </mat-option>

          </mat-select>
          <mat-error *ngIf="recomendacionForm.get('registroEmocionalId')?.hasError('required')">
            Seleccione un registro
          </mat-error>
        </mat-form-field>


      </div>

      <!-- Campo de recomendación -->
      <mat-form-field appearance="fill" class="form-field-full">
        <mat-label>Recomendación</mat-label>
        <textarea matInput formControlName="mensaje" rows="4"
                  placeholder="Mantener una rutina de sueño y practicar respiración..."></textarea>
        <mat-error *ngIf="recomendacionForm.get('mensaje')?.hasError('required')">
          El mensaje es requerido
        </mat-error>
      </mat-form-field>

      <!-- Tipo de recomendación -->
      <div class="form-group">
        <label class="mat-label">Tipo</label>
        <mat-radio-group formControlName="tipo" class="tipo-options-group">
          <mat-radio-button value="EMOCIONAL">EMOCIONAL</mat-radio-button>
          <mat-radio-button value="GENERAL">GENERAL</mat-radio-button>
          <mat-radio-button value="BIENESTAR">BIENESTAR</mat-radio-button>
        </mat-radio-group>
        <mat-error
          *ngIf="recomendacionForm.get('tipo')?.hasError('required') && recomendacionForm.get('tipo')?.touched">
          Seleccione un tipo
        </mat-error>
      </div>

      <!-- Botón guardar -->
      <button type="submit" mat-raised-button class="btn-guardar">
        GUARDAR
      </button>
    </form>
  </div>

  <!-- Historial de recomendaciones -->
  <div class="history-container">
    <h3 class="history-title">HISTORIAL DE RECOMENDACIONES</h3>

    <div class="history-table-wrapper mat-elevation-z4">
      <table mat-table [dataSource]="dataSourceHistorialRecomendaciones" class="history-table">

        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef> ID_Recomendacion </th>
          <td mat-cell *matCellDef="let row"> {{row.id}} </td>
        </ng-container>

        <ng-container matColumnDef="nombreEstudiante">
          <th mat-header-cell *matHeaderCellDef> ID_Estudiante </th>
          <td mat-cell *matCellDef="let row"> {{row.usuarioId}} </td>
        </ng-container>

        <ng-container matColumnDef="registroEmocionalId">
          <th mat-header-cell *matHeaderCellDef> ID_Registro_Emocional </th>
          <td mat-cell *matCellDef="let row"> {{row.registroEmocionalId}} </td>
        </ng-container>

        <ng-container matColumnDef="tipo">
          <th mat-header-cell *matHeaderCellDef> Tipo </th>
          <td mat-cell *matCellDef="let row"> {{row.tipo}} </td>
        </ng-container>

        <ng-container matColumnDef="mensaje">
          <th mat-header-cell *matHeaderCellDef> Recomendación </th>
          <td mat-cell *matCellDef="let row"> {{row.mensaje}} </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsRecomendaciones"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsRecomendaciones;"></tr>
      </table>

      <div *ngIf="dataSourceHistorialRecomendaciones.data.length === 0" class="no-data-cell">
        No hay recomendaciones en el historial.
      </div>
    </div>
  </div>
</div>
